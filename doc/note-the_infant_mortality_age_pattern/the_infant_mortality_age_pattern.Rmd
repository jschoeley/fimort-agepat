---
title: "Microdata Analysis of the Infant Mortality Age Pattern"
author: "Jonas SchÃ¶ley"
date: "October 15, 2015"
output: 
  html_document:
    fig_caption: yes
    keep_md: yes
    pandoc_args: --smart
---

> - In the 2010 US birth cohort 40.6 % of all infant deaths happen at the day of birth, 52.6 % during the first week of life.
> - During the first 50 days of life the decline in infant mortality rates is faster than exponential. After 50 days the decline settles at a constant exponential rate.

```{r echo=FALSE}
knitr::opts_chunk$set(cache   = TRUE,
                      error   = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      tidy    = FALSE)
```

This analysis describes the age pattern of infant mortality in days over the first year of life for the 2010 US birth cohort. We use publicly available individual-level data from the *National Center for Health Statistics* on births and infant deaths on US territory for the 2010 birth cohort.^[ftp://ftp.cdc.gov/pub/Health_Statistics/NCHS/Datasets/DVS/cohortlinkedus/] The data used in this article has been pre-selected and formatted by the author.

```{r}
library(dplyr)
library(tidyr)
library(lubridate)
library(ggplot2)
library(survival)

load("./data/usc10infant.Rdata")
usc10infant
```

The 2010 US birth cohort has a size of `r format(nrow(usc10infant), big.mark = ",")`. During their first year of life `r format(nrow(subset(usc10infant, !is.na(usc10infant$AGED))), big.mark = ",")` infants of that cohort died.

In order to analyze the age pattern of infant mortality we calculate exposures and deaths by days. To do so we tabulate our microdata using the `surfit` function of the `survival` package. The survival time until death is given by the variable `AGED` (age at death in days). An observation is censored at 365 days if no death occurred until then.

```{r}
# construct survival analysis variables
usc10infant %>%
  mutate(
    # survival event death
    surve_death = ifelse(is.na(AGED), 0, 1),
    # survival time until death or censoring
    survt_death = ifelse(surve_death == 0, 365, AGED)
  ) -> usc10infant_anly

# we use the survfit function to get age-specific exposures
# and deaths from the microdata in order to construct a lifetable
usc10infant_surv <- Surv(time  = usc10infant_anly$survt_death,
                         event = usc10infant_anly$surve_death,
                         type  = "right")
# total population
usc10infant_survfit <- survfit(usc10infant_surv ~ 1)
```

Now that we tabulated the data according to deaths and exposures by day we can construct a cohort lifetable for infants by day.

```{r}
#' Construct a Cohort Lifetable from a Survfit Object
CohortLifetable <- function (survfit_object) {
  data_frame(
    x    = survfit_object$time,
    Dx   = survfit_object$n.event,
    Nx   = survfit_object$n.risk,
    mx   = Dx / Nx,
    qx   = mx,
    px   = 1-qx,
    lx   = c(1, cumprod(px[-length(px)])),
    dx   = Dx / sum(Dx)
  )
}

# build lifetables
usc10infant_lifetable <- CohortLifetable(usc10infant_survfit)
```

`r format(usc10infant_lifetable$dx[1]*100, digits = 3)` % of all infant deaths during the first year of life happen at the day of birth, `r format(sum(usc10infant_lifetable$dx[1:7])*100, digits = 3)` % during the first week of life.

```{r, fig.cap="Survival probabilities over the first 364 days of life of the US birth cohort 2010."}
# survival curve
ggplot(usc10infant_lifetable, aes(x = x, y = lx)) +
  geom_step()
```

During the first 50 days of life the decline in infant mortality rates is faster than exponential. After 50 days the decline settles at a constant exponential rate.

```{r, fig.cap="Mortality Rates over the first 364 days of life of the US birth cohort 2010. Log-transformed y-scale."}
# mortality rates log transformed y scale
ggplot(usc10infant_lifetable, aes(x = x, y = mx)) +
  geom_step() +
  scale_y_log10()
```

```{r, fig.cap="Mortality Rates over the first 7--364 days of life of the US birth cohort 2010."}
ggplot(filter(usc10infant_lifetable, !(x %in% 0:6)), aes(x = x, y = mx)) +
  geom_line()
```

```{r, fig.cap="Mortality Rates over the first 7--364 days of life of the US birth cohort 2010. Fitted double exponential curve."}
usc10infant_lifetable %>%
  filter(!(x %in% 0:6)) %>%
  nls(data = .,
      formula = mx ~ a^x^b,
      start = list(a = 0.1, b = 0.1),
      weights = Nx) %>% coef() -> usc10infant_coef

# mortality rates starting week 1 fitted with double exponential curve
ggplot(filter(usc10infant_lifetable, !(x %in% 0:6)), aes(x = x, y = mx)) +
  geom_point() +
#   geom_smooth(method = "nls", formula = y ~ a^x^c, start = list(a = 0.1, c = 0.1),
#               se = FALSE, colour = "red") +
  stat_function(fun = function (x, a, b) {a^x^b},
                args = list(a = usc10infant_coef["a"],
                            b = usc10infant_coef["b"]),
                colour = "red") +
  annotate(geom = "text", x = 100, y = 4e-05,
           label = paste0("mx = a^x^b\n",
                          paste0(paste(names(usc10infant_coef),
                                       "=",
                                       format(usc10infant_coef,
                                              scientific = TRUE,
                                              digits = 3)),
                                 collapse = "\n"))
  )
```

